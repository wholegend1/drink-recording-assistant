<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æœˆåº•ç ´ç”¢å…‡æ‰‹åå–®</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FFF8E1' stroke='%23FFB74D' stroke-width='2'/%3E%3Ccircle cx='50' cy='45' r='28' fill='%23FFCCBC'/%3E%3Ccircle cx='35' cy='50' r='4' fill='%23FFAB91' opacity='0.6'/%3E%3Ccircle cx='65' cy='50' r='4' fill='%23FFAB91' opacity='0.6'/%3E%3Ccircle cx='40' cy='42' r='2.5' fill='%235D4037'/%3E%3Ccircle cx='60' cy='42' r='2.5' fill='%235D4037'/%3E%3Cpath d='M46 50 q4 3 8 0' stroke='%235D4037' stroke-width='1.5' fill='none'/%3E%3Cpath d='M25 80 Q50 95 75 80 L75 100 L25 100 Z' fill='%23FFCC80'/%3E%3Ccircle cx='35' cy='75' r='6' fill='%23FFCCBC'/%3E%3Ccircle cx='65' cy='75' r='6' fill='%23FFCCBC'/%3E%3Cpath d='M40 65 h20 l-2 25 h-16 Z' fill='%238D6E63'/%3E%3Cline x1='50' y1='65' x2='55' y2='55' stroke='%233E2723' stroke-width='3' stroke-linecap='round'/%3E%3Ccircle cx='45' cy='85' r='1.5' fill='%23000'/%3E%3Ccircle cx='52' cy='80' r='1.5' fill='%23000'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FFF8E1'/%3E%3Ccircle cx='50' cy='45' r='28' fill='%23FFCCBC'/%3E%3Ccircle cx='40' cy='42' r='2.5' fill='%235D4037'/%3E%3Ccircle cx='60' cy='42' r='2.5' fill='%235D4037'/%3E%3Cpath d='M40 65 h20 l-2 25 h-16 Z' fill='%238D6E63'/%3E%3C/svg%3E">

    <style>
        /* --- è®Šæ•¸å®šç¾© --- */
        :root {
            --primary: #6B8E78;
            --primary-light: #E8F3EB;
            --primary-dark: #4A6354;
            --accent: #D67D7D;
            --today-border: #FF5252;
            --bg: #F2F4F6;
            --text: #2C3E50;
            --card-bg: #FFFFFF;
            --input-bg: #F9FAFB;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --radius: 20px;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            padding-bottom: calc(100px + var(--safe-bottom)); /* å¢åŠ åº•éƒ¨ç·©è¡ */
            overflow-x: hidden;
        }

        .icon { width: 20px; height: 20px; fill: currentColor; }
        
        header {
            background: var(--card-bg); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            position: sticky; top: 0; z-index: 100;
            padding-top: max(15px, env(safe-area-inset-top)); /* ç€æµ·é©é… */
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--text); letter-spacing: 1px; }
        .icon-btn { border: none; background: none; font-size: 1.5rem; cursor: pointer; padding: 5px; color: var(--text); display:flex; align-items:center; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px;
            margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02);
            position: relative;
        }

        /* --- iOS è¡¨å–®å…ƒä»¶å¼·åˆ¶ä¿®æ­£ --- */
        .form-group { margin-bottom: 15px; position: relative; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; color: #888; }

        /* é€šç”¨ Input é‡ç½® */
        input:not([type="checkbox"]), select {
            width: 100%; height: 50px; padding: 0 15px; border: 2px solid #E5E7EB;
            border-radius: 16px; font-size: 16px; /* 16px é˜²æ­¢ iOS ç¸®æ”¾ */
            box-sizing: border-box;
            background-color: var(--input-bg); color: var(--text);
            -webkit-appearance: none; /* é—œéµï¼šç§»é™¤ iOS é è¨­æ¨£å¼ */
            appearance: none; 
            transition: 0.2s;
            line-height: normal; /* ä¿®æ­£å‚ç›´å°é½Š */
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 18px; padding-right: 40px;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: #FFF; }

        /* Fix 1: æ—¥æœŸé¸æ“‡å™¨å¾¹åº•é‡å¯« (iOS ç›¸å®¹) */
        input[type="date"] {
            display: block; 
            width: 100%; 
            max-width: 100%; /* é˜²æ­¢è·‘ç‰ˆ */
            margin: 0;
            background: #FFF; 
            border: 2px solid #E5E7EB;
            font-weight: 700; 
            color: var(--primary-dark);
            text-align: center; 
            cursor: pointer;
            padding: 0;
            /* Flexbox ç½®ä¸­æ–‡å­— */
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
            min-height: 50px;
        }
        /* éš±è—åŸç”Ÿ iconï¼Œæ”¹ç”¨æ•´æ¢å¯é» */
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer;
        }
        input[type="date"]::-webkit-date-and-time-value {
            margin: 0 auto; /* æ–‡å­—ç½®ä¸­ */
        }

        /* åŠ æ–™å€ */
        .topping-area { background: #F8F9FA; padding: 15px; border-radius: 16px; border: 1px solid #EEE; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .topping-tag-btn {
            background: white; border: 1px solid #DDD; color: #666;
            padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: 0.1s; display: flex; align-items: center; gap: 5px;
        }
        .topping-tag-btn:active { transform: scale(0.95); background: var(--primary-light); color: var(--primary); }
        .topping-item-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #FFF; padding: 8px 12px; margin-bottom: 8px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 3px solid var(--primary);
        }
        .topping-controls { display: flex; gap: 6px; }
        .t-btn {
            border: 1px solid #EEE; background: #FAFAFA; border-radius: 8px;
            padding: 6px 10px; font-size: 0.8rem; cursor: pointer; color: #555;
            min-width: 35px; text-align: center;
        }

        /* æŒ‰éˆ• */
        .input-group { display: flex; gap: 8px; align-items: stretch; }
        .btn-icon {
            width: 50px; flex-shrink: 0; background: var(--primary); color: white; border: none;
            border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-icon:active { transform: scale(0.95); }
        .btn-icon.danger { background: #FF6B6B; }

        .btn-primary {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 16px; border-radius: 16px; font-size: 1.1rem; font-weight: 800;
            cursor: pointer; box-shadow: 0 4px 15px -3px var(--primary); margin-top: 15px;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-cancel { width: 100%; padding: 15px; background: transparent; border: none; color: #999; cursor: pointer; font-size: 16px;}

        .checkbox-group { display: flex; gap: 10px; margin-top: 5px; }
        .checkbox-btn {
            flex: 1; padding: 14px; border: 2px solid #E5E7EB; border-radius: 14px;
            font-weight: 700; color: #AAA; cursor: pointer; transition: 0.2s; background: #FFF;
            display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 16px;
        }
        .checkbox-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

        /* æœˆæ›† */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; padding-top: 10px;}
        .calendar-nav-btn { background: #FFF; border: 1px solid #EEE; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; font-size: 1rem; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .day-name { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; font-weight: 700; }
        
        .day {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 14px; font-size: 1rem; cursor: pointer; position: relative; 
            background: #FFF; border-bottom: 3px solid #E5E7EB; color: #888; transition: 0.1s;
        }
        .day:active { transform: translateY(2px); border-bottom-width: 1px; }
        .day.today { border: 2px solid var(--today-border); color: var(--today-border); font-weight: 900; }
        
        .day.has-record { background-color: var(--primary-light); color: var(--primary-dark); font-weight: 800; border-bottom-color: var(--primary); }
        .day-badge {
            position: absolute; top: -5px; right: -5px;
            background: #FF5252; color: white; border-radius: 50%;
            width: 18px; height: 18px; font-size: 0.7rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .day.selected { box-shadow: inset 0 0 0 3px #333; transform: scale(0.95); }
        .day.future { opacity: 0.2; pointer-events: none; background: #eee; border: none; }

        .back-today-container { position: absolute; top: -10px; right: 0; width: 100%; text-align: right; }
        .back-today-btn { background: var(--text); color: white; border: none; padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; cursor: pointer; display: inline-block; }

        /* åˆ†æåœ–è¡¨ */
        .progress-bar-container { background: #EEE; border-radius: 10px; height: 12px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { background: #4CAF50; height: 100%; border-radius: 10px; transition: width 0.5s ease; }
        
        .weekly-chart { 
            display: flex; align-items: flex-end; justify-content: space-between; 
            height: 120px; 
            margin-top: 15px; 
            padding-bottom: 20px; 
        }
        .weekly-bar-col { 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            width: 12%; height: 100%; 
            position: relative;
        }
        .weekly-value {
            font-size: 0.7rem; font-weight: bold; color: var(--primary);
            margin-bottom: 2px;
        }
        .weekly-bar { 
            background: var(--primary); 
            width: 80%; 
            border-radius: 6px 6px 0 0; 
            transition: height 0.5s ease; 
            opacity: 0.6;
            min-height: 4px;
        }
        .weekly-bar.max { opacity: 1; background: var(--primary-dark); }
        .weekly-label { 
            font-size: 0.75rem; color: #888; 
            position: absolute; bottom: -20px;
        }

        .record-item { background: white; padding: 18px; margin-bottom: 12px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02); border-left: 5px solid var(--primary); }
        .ranking-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .rank-badge { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; color: white; margin-right: 12px; flex-shrink: 0; }
        .rank-1 { background: #FFD700; } .rank-2 { background: #C0C0C0; } .rank-3 { background: #CD7F32; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .color-dot { 
            aspect-ratio: 1; border-radius: 50%; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid white; width: 100%; max-width: 50px; margin: 0 auto;
            position: relative;
        }
        .color-dot.active::after { content: 'âœ“'; color: white; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        .menu-manager-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .menu-list { background: #F9FAFB; padding: 10px; border-radius: 12px; max-height: 300px; overflow-y: auto; border: 1px solid #EEE; }

        /* åº•éƒ¨å°èˆª (iOS Safe Area) */
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            height: calc(85px + var(--safe-bottom)); 
            padding-bottom: var(--safe-bottom);
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 200; 
            border-top: 1px solid rgba(0,0,0,0.05); 
        }
        .nav-item { text-align: center; color: #ccc; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .fab-container { position: relative; width: 70px; height: 70px; display: flex; justify-content: center; }
        .fab { position: absolute; top: -30px; width: 64px; height: 64px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 6px solid var(--bg); cursor: pointer; transition: 0.2s; }
        .fab.disabled { background: #CCC; cursor: not-allowed; box-shadow: none; pointer-events: none; }
        
        .settings-list { list-style: none; padding: 0; margin: 0; }
        .settings-item { padding: 18px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .btn-finish { width: 100%; margin-top: 20px; padding: 14px; border: none; background: #EEE; border-radius: 12px; color: #666; font-weight: bold; transition: 0.3s; cursor: pointer;}
        .btn-finish.dirty { background: #FFD54F; color: #333; box-shadow: 0 4px 10px rgba(255, 213, 79, 0.4); }
        
        .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; margin-left: 5px; font-weight: bold; }
        .badge-eco { background: #E8F5E9; color: #2E7D32; }
        .badge-treat { background: #FFEBEE; color: #C62828; }
        
        .today-status-card { text-align: center; padding: 25px 20px; }
        .streak-badge { background: #FFEDD5; color: #EA580C; font-weight: bold; font-size: 0.9rem; padding: 8px 16px; border-radius: 20px; display: inline-block; margin-top: 10px; }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<datalist id="shopList"></datalist>
<datalist id="itemList"></datalist>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="handleFileImport(this)">

<header>
    <h1>æœˆåº•ç ´ç”¢å…‡æ‰‹åå–®</h1>
    <button class="icon-btn" onclick="goToPage('settings')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
    </button>
</header>

<div id="page-calendar" class="page active container">
    <div class="card" style="text-align:center; padding:25px;">
        <div style="font-size:0.9rem; color:#888; margin-bottom:5px;">ğŸ“… ä»Šæ—¥æˆ°æ³</div>
        <div id="todayStatusContent"></div>
    </div>

    <div class="card">
        <div class="calendar-header">
            <div class="back-today-container">
                <button id="backToTodayBtn" class="back-today-btn" onclick="resetToToday()">â†© å›åˆ°æœ¬æœˆ</button>
            </div>
            <button onclick="changeMonth(-1)" class="calendar-nav-btn">â®</button>
            <span id="monthYear" style="font-weight:800;font-size:1.2rem;color:var(--primary)"></span>
            <button onclick="changeMonth(1)" class="calendar-nav-btn">â¯</button>
        </div>
        <div class="calendar-grid" id="calendar"></div>
    </div>

    <div class="card" style="background:var(--primary-light); border:none; text-align:center;">
        <div style="font-size:0.9rem; color:var(--primary-dark)">æœ¬æœˆç›®å‰èŠ±è²»</div>
        <div style="font-size:2rem; font-weight:800; color:var(--primary)" id="homeMonthTotal">$0</div>
    </div>
</div>

<div id="page-day-detail" class="page container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <button onclick="goToPage('calendar')" style="background:none;border:none;font-size:1.5rem;color:var(--text)">â®</button>
        <h2 id="detailDateBanner" style="margin:0; font-size:1.2rem;"></h2>
        <div style="width:24px;"></div>
    </div>
    <div id="dayRecordList"></div>
</div>

<div id="page-form" class="page container">
    <div class="card">
        <h3 style="margin-top:0; color:var(--primary); text-align:center;" id="formTitle">æ–°å¢ç´€éŒ„</h3>
        <form id="drinkForm">
            <div class="form-group" style="text-align:center;">
                <label>æ—¥æœŸ</label>
                <div style="position:relative; width:100%; max-width:250px; margin:0 auto;">
                    <input type="date" id="recordDate" required onchange="checkDateValidity()">
                </div>
            </div>

            <div class="form-group">
                <label>åº—å®¶åç¨±</label>
                <input type="text" id="shopName" list="shopList" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." required autocomplete="off" onchange="handleShopChange()">
            </div>
            
            <div class="form-group">
                <label>é£²æ–™å“é …</label>
                <input type="text" id="itemName" list="itemList" placeholder="è«‹å…ˆé¸æ“‡åº—å®¶" required autocomplete="off" oninput="handlePriceAutofill()">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å–®åƒ¹</label>
                    <input type="number" id="price" placeholder="$" inputmode="numeric" required min="0">
                </div>
            </div>

            <div class="form-group">
                <label>âœ¨ åŠ æ–™å€</label>
                <div class="topping-area">
                    <div style="font-size:0.8rem;color:#999;margin-bottom:5px;">å¸¸ç”¨åŠ æ–™ (é»æ“ŠåŠ å…¥)</div>
                    <div id="presetToppingTags" class="tag-container"></div>
                    
                    <div class="input-group" style="margin-top:10px;">
                        <input type="text" id="toppingInput" placeholder="è‡ªè¨‚: æ¤°æœ10 (è‡ªå‹•å„²å­˜)" style="flex:1;">
                        <button type="button" class="btn-icon" onclick="addToppingFromInput()">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </button>
                    </div>
                    
                    <div id="toppingListDisplay" style="margin-top:15px;"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ç”œåº¦</label>
                    <select id="sugar"><option value="æ­£å¸¸ç”œ">æ­£å¸¸ç”œ</option><option value="å°‘ç³–">å°‘ç³–</option><option value="åŠç³–">åŠç³–</option><option value="å¾®ç³–">å¾®ç³–</option><option value="ç„¡ç³–">ç„¡ç³–</option></select>
                </div>
                <div class="form-group">
                    <label>å†°å¡Š</label>
                    <select id="ice"><option value="æ­£å¸¸å†°">æ­£å¸¸å†°</option><option value="å°‘å†°">å°‘å†°</option><option value="å¾®å†°">å¾®å†°</option><option value="å»å†°">å»å†°</option><option value="ç†±">ç†±</option></select>
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-btn" id="btnEco" onclick="toggleOption(this, 'isEco')">
                    <span>ğŸŒ</span> ç’°ä¿æ¯ -5
                </div>
                <div class="checkbox-btn" id="btnTreat" onclick="toggleOption(this, 'isTreat')">
                    <span>ğŸ</span> è«‹å®¢ $0
                </div>
            </div>

            <button type="submit" class="btn-primary" id="formSubmitBtn">å„²å­˜</button>
            <button type="button" class="btn-cancel" onclick="goToPage('calendar')">å–æ¶ˆ</button>
        </form>
    </div>
</div>

<div id="page-stats" class="page container">
    <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
        <select id="statScope" onchange="renderStats()" style="width:auto; height:40px; padding:0 30px 0 15px;">
            <option value="month">æœ¬æœˆæ•¸æ“š</option>
            <option value="year">å¹´åº¦æ•¸æ“š</option>
        </select>
    </div>
    
    <div class="card">
        <h3>ğŸŒ ç’°ä¿æ¯ä½¿ç”¨ç‡</h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span id="ecoRateText">0%</span>
            <span id="ecoCountText" style="color:#888; font-size:0.8rem;">0/0 æ¯</span>
        </div>
        <div class="progress-bar-container">
            <div id="ecoProgressBar" class="progress-bar-fill" style="width:0%"></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“… é£²ç”¨ç¿’æ…£åˆ†ä½ˆ (æ¯)</h3>
        <div id="weeklyChart" class="weekly-chart"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:15px;">
        <div class="card" style="margin:0; text-align:center;">
            <div style="font-size:0.8rem; color:#888;">ç¸½èŠ±è²»</div>
            <div style="font-size:1.5rem; font-weight:800; color:var(--accent)" id="statSpend">0</div>
        </div>
        <div class="card" style="margin:0; text-align:center;">
            <div style="font-size:0.8rem; color:#888;">ç¸½æ¯æ•¸</div>
            <div style="font-size:1.5rem; font-weight:800; color:var(--primary)" id="statCups">0</div>
        </div>
    </div>
    <div class="card"><h3>ğŸ† æœ€æ„›åº—å®¶</h3><div id="listShopTop"></div></div>
    <div class="card"><h3>ğŸ˜ˆ ç½ªæƒ¡çµ„åˆ</h3><div id="listGuiltyCombo"></div></div>
    <div class="card"><h3>ğŸ¥¤ æœ€æ„›é£²æ–™</h3><div id="listItemTop"></div></div>
    <div class="card"><h3>âœ¨ åŠ æ–™ç‹</h3><div id="listToppingTop"></div></div>
</div>

<div id="page-settings" class="page container">
    <div style="display:flex; align-items:center; margin-bottom:20px;">
        <button onclick="goToPage('calendar')" style="background:none;border:none;font-size:1.5rem;margin-right:10px;">â®</button>
        <h2 style="margin:0;">è¨­å®š</h2>
    </div>

    <div class="card" style="padding:0;">
        <ul class="settings-list">
            <li class="settings-item" onclick="openMenuManagerModal()" style="padding:20px;">
                <div style="display:flex; align-items:center;">
                    <span class="settings-icon">ğŸ“‹</span>
                    <span style="font-weight:bold;">èœå–®ç®¡ç† (åº—å®¶/é£²æ–™)</span>
                </div>
                <span class="settings-arrow">â¯</span>
            </li>
             <li class="settings-item" onclick="openPresetModal()" style="padding:20px;">
                <div style="display:flex; align-items:center;">
                    <span class="settings-icon">ğŸ§‚</span>
                    <span>å¸¸ç”¨åŠ æ–™èˆ‡åå¥½</span>
                </div>
                <span class="settings-arrow">â¯</span>
            </li>
            <li class="settings-item" onclick="openThemeModal()" style="padding:20px;">
                <div style="display:flex; align-items:center;">
                    <span class="settings-icon">ğŸ¨</span>
                    <span>ä¸»é¡Œé¢¨æ ¼</span>
                </div>
                <div style="display:flex; align-items:center;">
                    <div id="currentThemeDot" style="width:10px; height:10px; border-radius:50%; margin-right:10px; border:1px solid #ddd;"></div>
                    <span class="settings-arrow">â¯</span>
                </div>
            </li>
            <li class="settings-item" onclick="exportData()" style="padding:20px;">
                <div style="display:flex; align-items:center;">
                    <span class="settings-icon">ğŸ“¤</span>
                    <span>å‚™ä»½è³‡æ–™ (JSON)</span>
                </div>
                <span class="settings-arrow">â¯</span>
            </li>
            <li class="settings-item" onclick="triggerImport()" style="padding:20px;">
                <div style="display:flex; align-items:center;">
                    <span class="settings-icon">ğŸ“¥</span>
                    <span>é‚„åŸè³‡æ–™</span>
                </div>
                <span class="settings-arrow">â¯</span>
            </li>
        </ul>
    </div>
    <div style="text-align:center; color:#CCC; font-size:0.8rem; margin-top:20px;">æœˆåº•ç ´ç”¢å…‡æ‰‹åå–® V18.0</div>
</div>

<div id="themeModal" class="modal-overlay" onclick="if(event.target === this) closeThemeModal()">
    <div class="modal-content">
        <h3>é¸æ“‡ä¸»é¡Œé¡è‰²</h3>
        
        <div style="margin-bottom:15px; padding:10px; background:#f9f9f9; border-radius:12px; display:flex; align-items:center; justify-content:center;">
            <input type="checkbox" id="autoThemeCheck" onchange="toggleAutoTheme()">
            <label for="autoThemeCheck" style="margin:0 0 0 8px; font-weight:normal;">ğŸ“… è‡ªå‹• (éš¨æœˆä»½æ›è‰²)</label>
        </div>

        <div class="theme-grid" id="themeGrid"></div>
        <button onclick="closeThemeModal()" style="margin-top:20px; background:none; border:none; color:#888; padding:10px;">é—œé–‰</button>
    </div>
</div>

<div id="menuManagerModal" class="modal-overlay" onclick="if(event.target === this) closeMenuManagerModal()">
    <div class="modal-content" style="text-align:left; width:95%; max-width:400px; height:80vh;">
        <h3 style="text-align:center; margin-top:0;">èœå–®ç®¡ç†</h3>
        
        <label>é¸æ“‡æˆ–æ–°å¢åº—å®¶</label>
        <div class="input-group" style="margin-bottom:15px;">
             <select id="crudShopSelect" onchange="renderCrudItems()" style="flex:1"></select>
             <button class="btn-icon" onclick="addShopPrompt()" title="æ–°å¢åº—å®¶">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
             </button>
             <button class="btn-icon danger" onclick="deleteShopPrompt()" title="åˆªé™¤åº—å®¶">
                <svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
             </button>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <label>é£²æ–™å“é …åˆ—è¡¨</label>
            <div id="crudItemList" class="menu-list" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
            
            <div style="background:#EEE; padding:10px; border-radius:12px;">
                <div style="font-size:0.8rem;color:#666;margin-bottom:5px;">æ–°å¢é£²æ–™</div>
                <div class="input-group">
                    <input type="text" id="crudNewItemName" placeholder="å“é …åç¨±" style="flex:2; height:40px;">
                    <input type="number" id="crudNewItemPrice" placeholder="$" style="flex:1; height:40px;">
                    <button class="btn-icon" onclick="addCrudItem()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <button id="btnSaveMenu" class="btn-finish" onclick="saveMenuChanges()">å„²å­˜è®Šæ›´</button>
    </div>
</div>

<div id="presetModal" class="modal-overlay" onclick="if(event.target === this) closePresetModal()">
    <div class="modal-content" style="text-align:left; width:90%;">
        <h3 style="text-align:center; margin-top:0;">å¸¸ç”¨åŠ æ–™èˆ‡åå¥½</h3>
        <label>é è¨­ç”œåº¦å†°å¡Š</label>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
             <select id="defaultSugar" onchange="markDirty()"><option>æ­£å¸¸ç”œ</option><option>å°‘ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select>
             <select id="defaultIce" onchange="markDirty()"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option><option>ç†±</option></select>
        </div>
        <label>å¸¸ç”¨åŠ æ–™ç®¡ç† (é»Xåˆªé™¤)</label>
        <div id="settingToppingList" class="tag-container" style="background:#f9f9f9; padding:10px; border-radius:12px; min-height:50px;"></div>
        <div class="input-group">
             <input type="text" id="newPresetToppingInput" placeholder="ä¾‹å¦‚: çç 10" style="flex:1; height:40px;">
             <button class="btn-icon" onclick="addPresetToppingSetting()">
                 <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
             </button>
        </div>
        <button id="btnSavePresets" class="btn-finish" onclick="saveDefaults()">å„²å­˜è®Šæ›´</button>
    </div>
</div>

<nav>
    <div class="nav-item active" id="nav-cal" onclick="goToPage('calendar')">
        <span class="nav-icon">ğŸ“…</span><span>æœˆæ›†</span>
    </div>
    <div class="fab-container">
        <div id="fabBtn" class="fab" onclick="handleFabClick()"><span>ï¼‹</span></div>
    </div>
    <div class="nav-item" id="nav-stat" onclick="goToPage('stats')">
        <span class="nav-icon">ğŸ“Š</span><span>åˆ†æ</span>
    </div>
</nav>

<script>
    let records = JSON.parse(localStorage.getItem('drinkRecords_v18')) || [];
    let presets = JSON.parse(localStorage.getItem('drinkPresets_v18')) || {
        menus: {}, toppings: [], defaultSugar: 'åŠç³–', defaultIce: 'å°‘å†°'
    };
    
    // Migration V16->V18 (Skip V17 internals)
    if (localStorage.getItem('drinkPresets_v16')) {
        try {
            const old = JSON.parse(localStorage.getItem('drinkPresets_v16'));
            if(!presets.menus || Object.keys(presets.menus).length === 0) presets = old;
            localStorage.setItem('drinkPresets_v18', JSON.stringify(presets));
        } catch(e) {}
    }

    let appState = {
        currentDate: new Date(),
        selectedDate: new Date(),
        editingId: null,
        currentToppings: [], 
        themeIndex: parseInt(localStorage.getItem('themeIndex')) || 0,
        isAutoTheme: localStorage.getItem('isAutoTheme') === 'true',
        isDirty: false
    };

    const slogans = [
        "å¤šå–æ°´æ²’äº‹ï¼Œæ²’äº‹å¤šå–æ°´ï¼ŒéŒ¢åŒ…æ›´å¿«æ¨‚ï¼", 
        "ä»Šå¤©æ²’å–é£²æ–™ï¼Œé›¢è²¡å¯Œè‡ªç”±åˆè¿‘äº†ä¸€æ­¥ï½", 
        "æ°´æ˜¯æœ€å¥½çš„é£²æ–™ï¼Œå¥åº·æ˜¯æœ€å¤§çš„è²¡å¯Œã€‚",
        "å¿ä½ä¸å–é£²æ–™çš„ä½ ï¼Œä»Šå¤©ç‰¹åˆ¥å¸¥æ°£ï¼", 
        "çœä¸‹çš„é£²æ–™éŒ¢ï¼Œæ˜¯ç‚ºäº†æ›´å¿«æ¨‚çš„æ˜å¤©ã€‚", 
        "å¤šå–æ°´èº«é«”å¥½ï¼Œå¿ƒæƒ…è‡ªç„¶æœƒè®Šå¥½ã€‚",
        "ä»Šå¤©ä¹Ÿæ˜¯å€‹å¥åº·çš„çœéŒ¢å°å¤©æ‰å‘¢ï¼", 
        "æ²’å–é£²æ–™çš„ä¸€å¤©ï¼Œæ¸…çˆ½ç„¡è² æ“”ï¼Œé–‹å¿ƒï¼", 
        "ä½ çš„è…è‡Ÿå’ŒéŒ¢åŒ…åŒæ™‚å°ä½ è¡¨ç¤ºæ„Ÿè¬ <3",
        "ç™½é–‹æ°´æœ€ç”˜ç”œï¼Œå¥åº·çš„å¿«æ¨‚æœ€é•·ä¹…ã€‚", 
        "å …æŒå¤šå–æ°´ï¼Œçš®è†šæ°´å™¹å™¹ï¼Œå¿ƒæƒ…äº®æ™¶æ™¶ã€‚", 
        "æ­å–œé”æˆã€Œä»Šæ—¥ç„¡ç³–ã€æˆå°±ï¼Œå¥åº·å€¼ +100ï¼"
    ];

    const themes = [
        { p: '#D68C8C', l: '#F9EBEB', d: '#A65C5C', m:'1æœˆ èƒ­è„‚ç´…' }, 
        { p: '#F48FB1', l: '#FCE4EC', d: '#C2185B', m:'2æœˆ æ«»èŠ±ç²‰' },
        { p: '#6B8E78', l: '#E8F3EB', d: '#4A6354', m:'3æœˆ å«©èŠ½ç¶ ' },
        { p: '#FFB74D', l: '#FFF3E0', d: '#F57C00', m:'4æœˆ é™½å…‰æ©™' },
        { p: '#4FC3F7', l: '#E1F5FE', d: '#0288D1', m:'5æœˆ å¤©ç©ºè—' },
        { p: '#9E8CAE', l: '#F3EBF9', d: '#6B547E', m:'6æœˆ è–°è¡£è‰' },
        { p: '#FF7043', l: '#FBE9E7', d: '#D84315', m:'7æœˆ çƒˆæ—¥ç´…' },
        { p: '#FFD54F', l: '#FFF8E1', d: '#FFA000', m:'8æœˆ é‡‘ç›èŠ±' },
        { p: '#90A4AE', l: '#ECEFF1', d: '#455A64', m:'9æœˆ è¿·éœ§ç°' },
        { p: '#8D6E63', l: '#EFEBE9', d: '#5D4037', m:'10æœˆ æ —å­æ£•' },
        { p: '#5C6BC0', l: '#E8EAF6', d: '#283593', m:'11æœˆ æ·±æµ·è—' },
        { p: '#26A69A', l: '#E0F2F1', d: '#00695C', m:'12æœˆ æ¾è‘‰é’' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        applyThemeLogic();
        appState.selectedDate = new Date();
        renderCalendar();
        updateHomeTotal();
        updateTodayStatus();
        checkFabStatus();
        document.getElementById('recordDate').valueAsDate = new Date();
        updateShopDatalist();
        
        renderThemeGrid();
        document.getElementById('autoThemeCheck').checked = appState.isAutoTheme;
    });

    function goToPage(pageId) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        if(['calendar','day-detail','form'].includes(pageId)) document.getElementById('nav-cal').classList.add('active');
        if(pageId === 'stats') { document.getElementById('nav-stat').classList.add('active'); renderStats(); }
        if(pageId === 'calendar') { updateTodayStatus(); checkFabStatus(); }
        window.scrollTo(0,0);
    }

    // --- Fix: Weekly Chart Logic (Exact Date Matching) ---
    function renderWeeklyChart(data) {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0(Sun)
        
        // Find "This Week's" 7 specific dates strings (YYYY-MM-DD)
        const weekDates = [];
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - dayOfWeek);
        
        for(let i=0; i<7; i++) {
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            weekDates.push(formatDate(d));
        }

        // Count for these specific dates
        const weekCounts = [0,0,0,0,0,0,0];
        weekDates.forEach((dateStr, idx) => {
            const count = records.filter(r => r.date === dateStr).length;
            weekCounts[idx] = count;
        });

        const maxVal = Math.max(...weekCounts);
        const daysLabel = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        
        document.getElementById('weeklyChart').innerHTML = weekCounts.map((count, i) => {
            let heightPct = 0;
            if (maxVal > 0) heightPct = (count / maxVal) * 70; 
            const isMax = (count === maxVal && count > 0);
            
            return `
            <div class="weekly-bar-col">
                <div class="weekly-value">${count > 0 ? count : ''}</div>
                <div class="weekly-bar ${isMax ? 'max' : ''}" style="height:${Math.max(heightPct, count > 0 ? 5 : 0)}%"></div>
                <div class="weekly-label">${daysLabel[i]}</div>
            </div>`;
        }).join('');
    }

    // --- Theme Logic ---
    function applyThemeLogic() {
        if (appState.isAutoTheme) {
            const currentMonth = new Date().getMonth(); 
            setTheme(currentMonth, false);
        } else {
            setTheme(appState.themeIndex, false);
        }
    }

    function toggleAutoTheme() {
        appState.isAutoTheme = document.getElementById('autoThemeCheck').checked;
        localStorage.setItem('isAutoTheme', appState.isAutoTheme);
        if (appState.isAutoTheme) {
            alert('å·²é–‹å•Ÿè‡ªå‹•æ¨¡å¼ï¼šå°‡æ ¹æ“šç•¶å‰æœˆä»½åˆ‡æ›é¡è‰²ï¼');
            const currentMonth = new Date().getMonth();
            setTheme(currentMonth, true); 
        }
        renderThemeGrid();
    }

    function renderThemeGrid() {
        const container = document.getElementById('themeGrid');
        container.innerHTML = themes.map((t, i) => `
            <div class="color-dot ${appState.themeIndex === i ? 'active' : ''}" 
                 style="background-color: ${t.p} !important;" 
                 onclick="manualSelectTheme(${i})"></div>
        `).join('');
    }

    function manualSelectTheme(idx) {
        if (appState.isAutoTheme) {
            appState.isAutoTheme = false;
            document.getElementById('autoThemeCheck').checked = false;
            localStorage.setItem('isAutoTheme', false);
            alert('å·²åˆ‡æ›ç‚ºæ‰‹å‹•é¸æ“‡ï¼Œè‡ªå‹•æ¨¡å¼å·²é—œé–‰ã€‚');
        }
        setTheme(idx, true);
        renderThemeGrid();
    }

    function setTheme(idx, save=true) {
        appState.themeIndex = idx;
        const t = themes[idx];
        const r = document.documentElement.style;
        r.setProperty('--primary', t.p);
        r.setProperty('--primary-light', t.l);
        r.setProperty('--primary-dark', t.d);
        document.getElementById('currentThemeDot').style.background = t.p;
        
        if(save) { localStorage.setItem('themeIndex', idx); closeThemeModal(); }
    }

    // --- Topping Logic ---
    function renderPresetToppingsInForm() {
        const container = document.getElementById('presetToppingTags');
        container.innerHTML = presets.toppings.map((t, idx) => `
            <div class="topping-tag-btn" onclick="addToppingFromTag(${idx})">
                ${t.name} $${t.price}
            </div>
        `).join('');
    }

    function addToppingFromTag(idx) {
        const t = presets.toppings[idx];
        addOrUpdateTopping(t.name, t.price);
    }

    function addToppingFromInput() {
        const val = document.getElementById('toppingInput').value.trim();
        if(!val) return;
        const match = val.match(/^(.+?)\s*(\d+)$/);
        if (match) {
            addOrUpdateTopping(match[1], parseInt(match[2]));
            document.getElementById('toppingInput').value = '';
        } else {
            alert('æ ¼å¼ç¯„ä¾‹: æ¤°æœ10');
        }
    }

    function addOrUpdateTopping(name, price) {
        const existing = appState.currentToppings.find(t => t.name === name && t.price === price);
        if(!existing) {
            appState.currentToppings.push({ name, price, count: 1, attr: 'æ­£å¸¸' });
        }
        renderToppingList();
    }

    function renderToppingList() {
        const container = document.getElementById('toppingListDisplay');
        container.innerHTML = appState.currentToppings.map((t, i) => `
            <div class="topping-item-row">
                <div class="topping-info">${t.name} ($${t.price})</div>
                <div class="topping-controls">
                    <div class="t-btn" onclick="updateToppingCount(${i})">x${t.count}</div>
                    <div class="t-btn" onclick="updateToppingAttr(${i})">${t.attr}</div>
                    <div class="t-btn del" onclick="removeTopping(${i})">âœ•</div>
                </div>
            </div>
        `).join('');
    }

    function updateToppingCount(i) { appState.currentToppings[i].count++; renderToppingList(); }
    function updateToppingAttr(i) {
        const attrs = ['æ­£å¸¸', 'å¤š', 'å°‘'];
        const currentIdx = attrs.indexOf(appState.currentToppings[i].attr);
        appState.currentToppings[i].attr = attrs[(currentIdx + 1) % 3];
        renderToppingList();
    }
    function removeTopping(i) { appState.currentToppings.splice(i, 1); renderToppingList(); }

    // --- Form Submit ---
    document.getElementById('drinkForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const dateVal = document.getElementById('recordDate').value;
        const shop = document.getElementById('shopName').value.trim();
        const item = document.getElementById('itemName').value.trim();
        const priceRaw = parseInt(document.getElementById('price').value);
        
        if (shop && item) {
            if (!presets.menus[shop]) presets.menus[shop] = [];
            if (!presets.menus[shop].some(m => m.name === item)) {
                presets.menus[shop].push({ name: item, price: priceRaw });
            }
        }
        appState.currentToppings.forEach(t => {
            if (!presets.toppings.some(pt => pt.name === t.name)) {
                presets.toppings.push({ name: t.name, price: t.price });
            }
        });
        localStorage.setItem('drinkPresets_v18', JSON.stringify(presets));

        const toppingTotal = appState.currentToppings.reduce((sum, t) => sum + (t.price * t.count), 0);
        let finalCost = priceRaw + toppingTotal;
        if(appState.options.isTreat) finalCost = 0;
        else if(appState.options.isEco) finalCost = Math.max(0, finalCost - 5);

        const newRecord = {
            id: appState.editingId || Date.now(),
            date: dateVal, shop, item,
            priceOriginal: priceRaw,
            toppings: appState.currentToppings,
            sugar: document.getElementById('sugar').value,
            ice: document.getElementById('ice').value,
            isEco: appState.options.isEco,
            isTreat: appState.options.isTreat,
            finalCost: finalCost
        };

        if(appState.editingId) {
            const idx = records.findIndex(r => r.id === appState.editingId);
            if(idx !== -1) records[idx] = newRecord;
        } else { records.push(newRecord); }

        saveRecords();
        updateDataLists();
        updateTodayStatus();
        
        const [y, m, d] = dateVal.split('-').map(Number);
        appState.selectedDate = new Date(y, m-1, d);
        appState.currentDate = new Date(y, m-1, 1);
        renderCalendar();
        goToPage('calendar');
    });

    function resetToToday() { appState.currentDate = new Date(); renderCalendar(); updateHomeTotal(); }

    function renderCalendar() {
        const year = appState.currentDate.getFullYear();
        const month = appState.currentDate.getMonth();
        document.getElementById('monthYear').innerText = `${year} / ${String(month + 1).padStart(2,'0')}`;
        const now = new Date();
        const btn = document.getElementById('backToTodayBtn');
        btn.style.display = (year === now.getFullYear() && month === now.getMonth()) ? 'none' : 'inline-block';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';
        
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => calendarEl.innerHTML += `<div class="day-name">${d}</div>`);
        for(let i=0; i<firstDay; i++) calendarEl.innerHTML += `<div></div>`;

        const todayStr = formatDate(new Date());
        const selectedStr = formatDate(appState.selectedDate);

        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dailyRecords = records.filter(r => r.date === dateStr);
            const cupCount = dailyRecords.length;
            const hasRecord = cupCount > 0;
            const isToday = dateStr === todayStr;
            const isSelected = dateStr === selectedStr;
            const isFuture = isFutureDate(new Date(year, month, i));
            
            const div = document.createElement('div');
            div.className = `day ${isToday?'today':''} ${hasRecord?'has-record':''} ${isSelected?'selected':''} ${isFuture?'future':''}`;
            div.innerText = i;
            if (hasRecord) {
                div.innerHTML += `<div class="day-badge">${cupCount}</div>`;
            }
            div.onclick = () => { if(!isFuture) handleDateClick(year, month, i); };
            calendarEl.appendChild(div);
        }
        checkFabStatus();
    }

    function renderStats() {
        const scope = document.getElementById('statScope').value;
        const now = new Date();
        const prefix = scope === 'month' ? `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}` : `${now.getFullYear()}`;
        const data = records.filter(r => r.date.startsWith(prefix));
        
        document.getElementById('statSpend').innerText = data.reduce((a,b)=>a+b.finalCost,0);
        document.getElementById('statCups').innerText = data.length;
        
        const ecoCount = data.filter(r => r.isEco).length;
        const totalCount = data.length;
        const ecoRate = totalCount > 0 ? Math.round((ecoCount/totalCount)*100) : 0;
        document.getElementById('ecoRateText').innerText = `${ecoRate}%`;
        document.getElementById('ecoCountText').innerText = `${ecoCount}/${totalCount} æ¯`;
        document.getElementById('ecoProgressBar').style.width = `${ecoRate}%`;

        renderWeeklyChart(records); // Pass all records, filter inside

        const shops={}; const items={}; const combos={}; const tops={};
        data.forEach(r => {
            shops[r.shop] = (shops[r.shop]||0)+r.finalCost;
            items[`${r.item} (${r.sugar}/${r.ice})`] = (items[`${r.item} (${r.sugar}/${r.ice})`]||0)+r.finalCost;
            if(r.toppings && r.toppings.length) { 
                const tStr = r.toppings.map(t=>t.name).join('+'); combos[`${r.shop}<br><span style="font-size:0.8rem;color:#888">${r.item}+${tStr}</span>`]=(combos[`${r.shop}<br><span style="font-size:0.8rem;color:#888">${r.item}+${tStr}</span>`]||0)+1;
                r.toppings.forEach(t => tops[`${t.name} <span style="font-size:0.8rem;color:#999">($${t.price} @ ${r.shop})</span>`]=(tops[`${t.name} <span style="font-size:0.8rem;color:#999">($${t.price} @ ${r.shop})</span>`]||0)+1);
            }
        });
        renderRank(shops, 'listShopTop', '$'); renderRank(items, 'listItemTop', '$'); renderRank(combos, 'listGuiltyCombo', '', 'æ¬¡'); renderRank(tops, 'listToppingTop', '', 'æ¬¡');
    }

    function viewDayDetails() { 
        const dateStr = formatDate(appState.selectedDate); 
        document.getElementById('detailDateBanner').innerText = dateStr; 
        const list = records.filter(r => r.date === dateStr); 
        document.getElementById('dayRecordList').innerHTML = list.length ? list.map(r => {
             let topStr = '';
             if(r.toppings && r.toppings.length) {
                 topStr = r.toppings.map(t => `+${t.name}x${t.count||1}(${t.attr||'æ­£å¸¸'})`).join(' ');
             } else if(r.toppingName) { topStr = `+${r.toppingName}`; }
             
             return `
             <div class="record-item" onclick="openEditForm(${r.id})">
                <div style="flex:1;">
                    <div style="font-weight:bold;">${r.shop} - ${r.item} ${r.isTreat?'<span class="badge badge-treat">è«‹å®¢</span>':''} ${r.isEco?'<span class="badge badge-eco">ç’°ä¿</span>':''}</div>
                    <div style="font-size:0.85rem;color:#888;">${r.sugar} ${r.ice} <span style="color:var(--accent)">${topStr}</span></div>
                </div>
                <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end;">
                    <div style="font-weight:800;font-size:1.2rem;">$${r.finalCost}</div>
                    <button onclick="event.stopPropagation();deleteRecord(${r.id})" style="border:none;background:none;color:#FF6B6B;font-size:1rem;margin-top:5px;cursor:pointer;">ğŸ—‘ï¸</button>
                </div>
             </div>`;
        }).join('') : '<div style="text-align:center;padding:40px;color:#aaa;">ğŸƒ æœ¬æ—¥ç„¡ç´€éŒ„</div>';
        goToPage('day-detail'); 
    }

    // --- Standard Helpers ---
    function openAddForm() { appState.editingId = null; appState.currentToppings = []; resetFormUI(); const d = appState.selectedDate; const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); document.getElementById('recordDate').value = `${yyyy}-${mm}-${dd}`; renderPresetToppingsInForm(); document.getElementById('formTitle').innerText = 'æ–°å¢ç´€éŒ„'; document.getElementById('formSubmitBtn').innerText = 'å„²å­˜'; goToPage('form'); }
    function resetFormUI() { document.getElementById('shopName').value = ''; document.getElementById('itemName').value = ''; document.getElementById('price').value = ''; document.getElementById('toppingInput').value = ''; document.getElementById('toppingListDisplay').innerHTML = ''; appState.options = { isEco: false, isTreat: false }; updateCheckboxUI(); document.getElementById('sugar').value = presets.defaultSugar; document.getElementById('ice').value = presets.defaultIce; handleShopChange(); }
    function openEditForm(id) { const record = records.find(r => r.id === id); if(!record) return; appState.editingId = id; document.getElementById('recordDate').value = record.date; document.getElementById('shopName').value = record.shop; handleShopChange(); document.getElementById('itemName').value = record.item; document.getElementById('price').value = record.priceOriginal; document.getElementById('sugar').value = record.sugar; document.getElementById('ice').value = record.ice; appState.currentToppings = record.toppings ? record.toppings.map(t=>({...t})) : []; if(!record.toppings && record.toppingName) appState.currentToppings.push({name:record.toppingName, price:record.toppingPrice||0, count:1, attr:'æ­£å¸¸'}); renderToppingList(); renderPresetToppingsInForm(); appState.options.isEco = record.isEco; appState.options.isTreat = record.isTreat; updateCheckboxUI(); document.getElementById('formTitle').innerText = 'ç·¨è¼¯ç´€éŒ„'; document.getElementById('formSubmitBtn').innerText = 'æ›´æ–°'; goToPage('form'); }
    function saveRecords() { localStorage.setItem('drinkRecords_v18', JSON.stringify(records)); updateHomeTotal(); }
    function deleteRecord(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { records = records.filter(r => r.id !== id); saveRecords(); viewDayDetails(); renderCalendar(); updateTodayStatus(); }}
    function handleDateClick(y, m, d) { const now = Date.now(); const clickedDate = new Date(y, m, d); if(now - appState.lastClickTime < 300 && isSameDate(clickedDate, appState.selectedDate)) viewDayDetails(); else { appState.selectedDate = clickedDate; renderCalendar(); } appState.lastClickTime = now; }
    function isFutureDate(date) { const today = new Date(); today.setHours(0,0,0,0); const target = new Date(date); target.setHours(0,0,0,0); return target > today; }
    function checkDateValidity() { if (isFutureDate(new Date(document.getElementById('recordDate').value))) { alert('ç„¡æ³•è¨˜éŒ„æœªä¾†æ—¥æœŸ'); document.getElementById('recordDate').valueAsDate = new Date(); } }
    function checkFabStatus() { const fab = document.getElementById('fabBtn'); if (isFutureDate(appState.selectedDate)) fab.classList.add('disabled'); else fab.classList.remove('disabled'); }
    function handleFabClick() { if (isFutureDate(appState.selectedDate)) return; openAddForm(); }
    function updateDataLists() { updateShopDatalist(); }
    function updateShopDatalist() { document.getElementById('shopList').innerHTML = Object.keys(presets.menus).map(s => `<option value="${s}">`).join(''); }
    function handleShopChange() { const s = document.getElementById('shopName').value; const l = document.getElementById('itemList'); document.getElementById('itemName').value=''; if(presets.menus[s]) { l.innerHTML=presets.menus[s].map(i=>`<option value="${i.name}">`).join(''); document.getElementById('itemName').placeholder=`é¸æ“‡ ${s} çš„é£²æ–™...`; } else { l.innerHTML=''; document.getElementById('itemName').placeholder="è¼¸å…¥æ–°é£²æ–™..."; } handlePriceAutofill(); }
    function handlePriceAutofill() { const s=document.getElementById('shopName').value; const i=document.getElementById('itemName').value; if(s&&i&&presets.menus[s]){ const m=presets.menus[s].find(x=>x.name===i); if(m) document.getElementById('price').value=m.price; } }
    function updateHomeTotal() { const y=appState.currentDate.getFullYear(); const m=String(appState.currentDate.getMonth()+1).padStart(2,'0'); const total = records.filter(r=>r.date.startsWith(`${y}-${m}`)).reduce((a,b)=>a+b.finalCost,0); document.getElementById('homeMonthTotal').innerText = `$${total}`; }
    function updateTodayStatus() { const todayStr = formatDate(new Date()); const total = records.filter(r=>r.date===todayStr).reduce((a,b)=>a+b.finalCost,0); const streak = getStreak(); let html = total===0 ? `<div style="font-size:0.9rem;color:#AAA;">${slogans[Math.floor(Math.random()*slogans.length)]}</div>` : `<div style="font-size:2.5rem;font-weight:800;color:var(--accent);">$${total}</div>`; if(streak>0) html+=`<div class="streak-badge">ğŸ”¥ å·²é€£çºŒå– ${streak} å¤©</div>`; document.getElementById('todayStatusContent').innerHTML = html; }
    function getStreak() { const dates = [...new Set(records.map(r=>r.date))].sort((a,b)=>new Date(b)-new Date(a)); if(!dates.length) return 0; const today=new Date(); today.setHours(0,0,0,0); const last=new Date(dates[0]); last.setHours(0,0,0,0); if(Math.round((today-last)/86400000)>1) return 0; let s=0; let prev=new Date(dates[0]); for(let i=0;i<dates.length;i++) { if(i===0){s++}else{ if(Math.round((prev-new Date(dates[i]))/86400000)===1){s++; prev=new Date(dates[i]);}else break;}} return s; }
    function renderRank(c, id, p='', s='') { const arr = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,3); document.getElementById(id).innerHTML = arr.length ? arr.map((x,i)=>`<div class="ranking-item"><div style="display:flex;align-items:center;"><div class="rank-badge rank-${i+1}">${i+1}</div><div>${x[0]}</div></div><div style="font-weight:bold;color:var(--primary)">${p}${x[1]}${s}</div></div>`).join('') : '<div style="color:#ccc;text-align:center;">ç„¡è³‡æ–™</div>'; }
    function exportData() { const backup = { version: "v18", records: records, presets: presets, themeIndex: appState.themeIndex }; const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup)); const a = document.createElement('a'); a.href = str; a.download = `drink_backup_v18_${formatDate(new Date())}.json`; document.body.appendChild(a); a.click(); a.remove(); }
    function triggerImport() { document.getElementById('importFile').click(); }
    function handleFileImport(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.version && data.version.startsWith("v")) { if(confirm('é‚„åŸå°‡è¦†è“‹ç¾æœ‰è¨­å®šï¼Œç¢ºå®šå—ï¼Ÿ')) { let count = 0; data.records.forEach(r => { if(!records.some(old=>old.id===r.id)) { records.push(r); count++; }}); presets = data.presets; localStorage.setItem('drinkPresets_v18', JSON.stringify(presets)); if(data.themeIndex !== undefined) setTheme(data.themeIndex); alert(`é‚„åŸæˆåŠŸï¼æ–°å¢ ${count} ç­†ã€‚`); } } else { alert('èˆŠç‰ˆæ ¼å¼ä¸æ”¯æ´è‡ªå‹•åˆä½µ'); } saveRecords(); location.reload(); } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; reader.readAsText(file); input.value = ''; }
    function updateCheckboxUI() { document.getElementById('btnEco').className = `checkbox-btn ${appState.options.isEco ? 'active' : ''}`; document.getElementById('btnTreat').className = `checkbox-btn ${appState.options.isTreat ? 'active' : ''}`; }
    function toggleOption(el, key) { appState.options[key] = !appState.options[key]; updateCheckboxUI(); }
    function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function changeMonth(d) { appState.currentDate.setMonth(appState.currentDate.getMonth()+d); renderCalendar(); updateHomeTotal(); }
    function isSameDate(d1, d2) { return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate(); }
    
    // Modal & Settings
    function openMenuManagerModal() { document.getElementById('menuManagerModal').style.display = 'flex'; appState.isDirty=false; updateMenuSaveButton(); const s=document.getElementById('crudShopSelect'); s.innerHTML='<option value="" disabled selected>è«‹é¸æ“‡åº—å®¶</option>'+Object.keys(presets.menus).map(k=>`<option value="${k}">${k}</option>`).join(''); document.getElementById('crudItemList').innerHTML='';}
    function closeMenuManagerModal() { document.getElementById('menuManagerModal').style.display = 'none'; }
    function markMenuDirty() { appState.isDirty = true; updateMenuSaveButton(); }
    function updateMenuSaveButton() { const btn = document.getElementById('btnSaveMenu'); if(appState.isDirty) { btn.classList.add('dirty'); btn.innerText = "å„²å­˜è®Šæ›´ (æœªå„²å­˜)"; } else { btn.classList.remove('dirty'); btn.innerText = "å„²å­˜è®Šæ›´"; } }
    function renderCrudItems() { const shop = document.getElementById('crudShopSelect').value; const container = document.getElementById('crudItemList'); if(!shop || !presets.menus[shop]) { container.innerHTML = ''; return; } container.innerHTML = presets.menus[shop].map((item, idx) => `<div class="menu-manager-row"><input type="text" value="${item.name}" onchange="updateCrudItem(${idx}, 'name', this.value)" style="flex:2; height:36px;"><input type="number" value="${item.price}" onchange="updateCrudItem(${idx}, 'price', this.value)" style="flex:1; height:36px;"><button class="btn-icon danger" onclick="deleteCrudItem(${idx})" style="width:36px; height:36px; border-radius:10px;"><svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>`).join(''); }
    function addShopPrompt() { const name = prompt("è«‹è¼¸å…¥æ–°åº—å®¶åç¨±ï¼š"); if(name && !presets.menus[name]) { presets.menus[name] = []; const select = document.getElementById('crudShopSelect'); select.innerHTML += `<option value="${name}">${name}</option>`; select.value = name; renderCrudItems(); markMenuDirty(); } }
    function deleteShopPrompt() { const name = document.getElementById('crudShopSelect').value; if(name && confirm(`ç¢ºå®šåˆªé™¤ ${name} åŠå…¶æ‰€æœ‰èœå–®å—ï¼Ÿ`)) { delete presets.menus[name]; openMenuManagerModal(); markMenuDirty(); } }
    function addCrudItem() { const shop = document.getElementById('crudShopSelect').value; const name = document.getElementById('crudNewItemName').value.trim(); const price = parseInt(document.getElementById('crudNewItemPrice').value) || 0; if(!shop) return alert('è«‹å…ˆé¸æ“‡åº—å®¶'); if(name) { presets.menus[shop].push({ name, price }); document.getElementById('crudNewItemName').value = ''; document.getElementById('crudNewItemPrice').value = ''; renderCrudItems(); markMenuDirty(); } }
    function updateCrudItem(idx, field, val) { const shop = document.getElementById('crudShopSelect').value; if(field === 'price') val = parseInt(val) || 0; presets.menus[shop][idx][field] = val; markMenuDirty(); }
    function deleteCrudItem(idx) { const shop = document.getElementById('crudShopSelect').value; presets.menus[shop].splice(idx, 1); renderCrudItems(); markMenuDirty(); }
    function saveMenuChanges() { localStorage.setItem('drinkPresets_v18', JSON.stringify(presets)); appState.isDirty = false; updateMenuSaveButton(); updateShopDatalist(); alert('èœå–®å·²å„²å­˜ï¼'); closeMenuManagerModal(); }
    function openPresetModal() { document.getElementById('presetModal').style.display='flex'; appState.isDirty=false; updateSaveButton(); renderSettingsToppingList(); document.getElementById('defaultSugar').value=presets.defaultSugar; document.getElementById('defaultIce').value=presets.defaultIce; }
    function closePresetModal() { document.getElementById('presetModal').style.display = 'none'; }
    function markDirty() { appState.isDirty = true; updateSaveButton(); }
    function updateSaveButton() { const btn = document.getElementById('btnSavePresets'); if(appState.isDirty) { btn.classList.add('dirty'); btn.innerText = "å„²å­˜è®Šæ›´ (æœªå„²å­˜)"; } else { btn.classList.remove('dirty'); btn.innerText = "å„²å­˜è®Šæ›´"; } }
    function addPresetToppingSetting() { const val = document.getElementById('newPresetToppingInput').value; const match = val.match(/^(.+?)\s*(\d+)$/); if(match) { presets.toppings.push({ name: match[1], price: parseInt(match[2]) }); document.getElementById('newPresetToppingInput').value = ''; renderSettingsToppingList(); markDirty(); } else { alert('æ ¼å¼éŒ¯èª¤ï¼Œä¾‹å¦‚ï¼šçç 10'); } }
    function removePresetTopping(idx) { if(confirm('åˆªé™¤æ­¤å¸¸ç”¨åŠ æ–™ï¼Ÿ')) { presets.toppings.splice(idx, 1); renderSettingsToppingList(); markDirty(); } }
    function renderSettingsToppingList() { document.getElementById('settingToppingList').innerHTML = presets.toppings.map((t, idx) => `<div class="topping-tag-btn" onclick="removePresetTopping(${idx})">${t.name} $${t.price} <span class="del-x">âœ•</span></div>`).join(''); }
    function saveDefaults() { presets.defaultSugar = document.getElementById('defaultSugar').value; presets.defaultIce = document.getElementById('defaultIce').value; localStorage.setItem('drinkPresets_v18', JSON.stringify(presets)); appState.isDirty = false; updateSaveButton(); alert('è¨­å®šå·²å„²å­˜ï¼'); closePresetModal(); }
    function openThemeModal() { document.getElementById('themeModal').style.display = 'flex'; }
    function closeThemeModal() { document.getElementById('themeModal').style.display = 'none'; }
</script>
</body>
</html>